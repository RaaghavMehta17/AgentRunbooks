{{- if .Values.backup.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "ops-agents.fullname" . }}-backup
  labels:
    {{- include "ops-agents.labels" . | nindent 4 }}
    app.kubernetes.io/component: backup
spec:
  schedule: {{ .Values.backup.schedule | quote }}
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "ops-agents.labels" . | nindent 12 }}
            app.kubernetes.io/component: backup
        spec:
          restartPolicy: OnFailure
          {{- if .Values.backup.destination == "pvc" }}
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: {{ include "ops-agents.fullname" . }}-backup-pvc
          {{- end }}
          containers:
            - name: backup
              image: postgres:16-alpine
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  BACKUP_DIR="/backup"
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  BACKUP_FILE="${BACKUP_DIR}/full_${TIMESTAMP}.sql"
                  WAL_DIR="${BACKUP_DIR}/wal"
                  
                  echo "Starting backup at $(date)"
                  
                  # Full backup
                  PGHOST="${DATABASE_HOST:-postgres}"
                  PGPORT="${DATABASE_PORT:-5432}"
                  PGDATABASE="${DATABASE_NAME:-ops_agents}"
                  PGUSER="${DATABASE_USER:-postgres}"
                  PGPASSWORD="${DATABASE_PASSWORD}"
                  
                  pg_dump -h "${PGHOST}" -p "${PGPORT}" -U "${PGUSER}" -d "${PGDATABASE}" \
                    -F c -f "${BACKUP_FILE}" || exit 1
                  
                  echo "Backup completed: ${BACKUP_FILE}"
                  
                  # Compress backup
                  gzip "${BACKUP_FILE}" || exit 1
                  echo "Backup compressed: ${BACKUP_FILE}.gz"
                  
                  {{- if eq .Values.backup.destination "s3" }}
                  # Upload to S3
                  export AWS_ACCESS_KEY_ID="${S3_ACCESS_KEY}"
                  export AWS_SECRET_ACCESS_KEY="${S3_SECRET_KEY}"
                  export AWS_ENDPOINT_URL="${S3_ENDPOINT}"
                  
                  aws s3 cp "${BACKUP_FILE}.gz" "s3://${S3_BUCKET}/full/${TIMESTAMP}.sql.gz" || exit 1
                  echo "Uploaded to S3: s3://${S3_BUCKET}/full/${TIMESTAMP}.sql.gz"
                  
                  # Cleanup old backups from S3 (keep last N days)
                  RETENTION_DAYS={{ .Values.backup.retentionDays }}
                  CUTOFF_DATE=$(date -d "${RETENTION_DAYS} days ago" +%Y%m%d 2>/dev/null || date -v-${RETENTION_DAYS}d +%Y%m%d)
                  aws s3 ls "s3://${S3_BUCKET}/full/" | while read -r line; do
                    FILE_DATE=$(echo "$line" | awk '{print $4}' | cut -d'_' -f1)
                    if [ -n "$FILE_DATE" ] && [ "$FILE_DATE" -lt "$CUTOFF_DATE" ]; then
                      FILE_NAME=$(echo "$line" | awk '{print $4}')
                      aws s3 rm "s3://${S3_BUCKET}/full/${FILE_NAME}" || true
                      echo "Deleted old backup: ${FILE_NAME}"
                    fi
                  done
                  {{- else }}
                  # Cleanup old backups from PVC (keep last N days)
                  RETENTION_DAYS={{ .Values.backup.retentionDays }}
                  find "${BACKUP_DIR}" -name "full_*.sql.gz" -type f -mtime +${RETENTION_DAYS} -delete || true
                  echo "Cleaned up backups older than ${RETENTION_DAYS} days"
                  {{- end }}
                  
                  echo "Backup job completed successfully at $(date)"
              env:
                - name: DATABASE_HOST
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "ops-agents.fullname" . }}-secrets
                      key: DATABASE_HOST
                      optional: true
                - name: DATABASE_PORT
                  value: "5432"
                - name: DATABASE_NAME
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "ops-agents.fullname" . }}-secrets
                      key: DATABASE_NAME
                      optional: true
                - name: DATABASE_USER
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "ops-agents.fullname" . }}-secrets
                      key: DATABASE_USER
                      optional: true
                - name: DATABASE_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "ops-agents.fullname" . }}-secrets
                      key: DATABASE_PASSWORD
                {{- if eq .Values.backup.destination "s3" }}
                - name: S3_BUCKET
                  value: {{ .Values.backup.s3.bucket | quote }}
                - name: S3_ENDPOINT
                  value: {{ .Values.backup.s3.endpoint | quote }}
                - name: S3_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "ops-agents.fullname" . }}-secrets
                      key: S3_ACCESS_KEY
                - name: S3_SECRET_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "ops-agents.fullname" . }}-secrets
                      key: S3_SECRET_KEY
                {{- end }}
              {{- if eq .Values.backup.destination "pvc" }}
              volumeMounts:
                - name: backup-storage
                  mountPath: /backup
              {{- end }}
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
{{- end }}

{{- if and .Values.backup.enabled (eq .Values.backup.destination "pvc") }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "ops-agents.fullname" . }}-backup-pvc
  labels:
    {{- include "ops-agents.labels" . | nindent 4 }}
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.backup.pvc.size }}
{{- end }}

